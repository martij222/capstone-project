---
title: "All-NBA Team Capstone"
author: "James Martinez"
date: "March 08, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
```

## Introduction

This capstone project will utilize historical NBA statistics from 1937 to 2012 to predict All-NBA Teams. Data used can be found [here](https://www.kaggle.com/open-source-sports/mens-professional-basketball).

## Loading the data sets

```{r}
# Store data as a tbl
players <- tbl_df(read.csv("basketball_players.csv"))
awards <- tbl_df(read.csv("basketball_awards_players.csv"))
allstar <- tbl_df(read.csv("basketball_player_allstar.csv"))

# Check the players data
players
```

Player data already appears to be tidy. As expected, nearly all of our variables of interest are numeric, and it looks like several variables (e.g. *oRebounds*, *dRebounds*, *threeAttempted*, *threeMade*) were not tracked in the early seasons. 


## Exploratory Data Analysis and Data Cleaning

First, the `setequal()` and `distinct()` functions are used to check for duplicate observations (just in case).

```{r}
# Check for duplicate observations
setequal(players, distinct(players))
setequal(awards, distinct(awards))
setequal(allstar, distinct(allstar))
```

### Trimming Some Data

#### The *players* Data Set

We'll be working with *players* first. The data set currently contains data from other leagues (e.g., ABA), as well as data from seasons before the first All-Star Game (pre-1950). We can start by removing these extra observations. Post-season stats, players with no games played, and miscellaneous features are also removed (Note that `lgID` is also removed after filtering).

```{r}
# Remove extraneous rows and columns 
players <- players %>% 
  filter(lgID == "NBA", year >= 1950, GP != 0) %>% 
  select(-contains("Post"), -c(note, stint, lgID, GS))

players
```



Now that the data set has been trimmed a bit, we can use the `summary()` function to view some general summary statistics.

```{r, echo=FALSE}
# Only summarize numeric variables
players %>% 
  select(-c(playerID, tmID)) %>% 
  summary()
```

Unfortunately, it looks like there are still several statistics that were not recorded since the inception of the All-Star game (which plenty of NBA historians would love to remind us of). We're concerned specifically with **rebounds and 3-pointers**. A bit of research reveals that [the NBA didn't begin recording offensive and defensive rebounds until the 1973-1974 season](https://en.wikipedia.org/wiki/Rebound_(basketball)), and [the 3-pointer wasn't adopted until 1979](https://www.usab.com/youth/news/2011/06/the-history-of-the-3-pointer.aspx). This means that we should only keep data from 1979 and later, but let's confirm that with `which.min()` just in case:

```{r}
# Group by year and sort by maxima
check <- players %>% 
  select(year, oRebounds, dRebounds, threeAttempted) %>% 
  group_by(year) %>% 
  summarize_if(is.numeric, max)

# Store the indices for the earliest year that each stat maxed out at 0
keep <- c(
  which.min(check$oRebounds == 0), 
  which.min(check$dRebounds == 0), 
  which.min(check$threeAttempted == 0))

# What's the earliest year we can keep?
check$year[max(keep)]
  
```

To prevent bias we need to retain data only for years in which **every statistic is available**, so we should get rid of observations before the 1979-1980 season.

```{r}
players <- players %>% 
  filter(year >= 1979)

players
```

Look's like we've shaved the *players* data set down from **23,751 x 42** to **14,577 x 20**!

#### The *awards* Data Sets

Now we can make similar adjustments to the data sets for end-of-season awards and All-Star games, which are much smaller than the *players* data set:

```{r}
awards
allstar
```

Similar to *players*, the *awards* data set has data for non-NBA leagues. It also has awards other than the All-NBA teams, such as **"Most Valuable Player"** and **"Rookie of the Year."** We'll only keep NBA data and relevant awards (Note that `grepl()` is used here, along with an appropriate regular expression).

```{r}
# Filter for league and year
awards <- awards %>% 
  filter(lgID == "NBA", year >= 1979) %>% 
  select(-c(note, lgID))

# Keep relevant awards
keep <- grepl("All-NBA\\sFirst|All-NBA\\sSecond|All-D|Valuable|Defensive", awards$award)
awards <- awards[keep,]

# Check for duplicate entries
setequal(awards, distinct(awards))
```

To prevent potential bias, **"All-NBA Third Team"** honors are disregarded, since the Third Team has only been selected from 1988 and on. **"Defensive Player of the Year"** is retained as there are only 3 seasons for which data is missing (Defensive POTY has been awarded since 1982). The `pos` variable is also retained, as each team must consist of two guards, two forwards, and one center. As a final step, we create indicator variables for each award.

```{r}
# Create indicator variables for each award
awards <- awards %>% 
  mutate(
    allDefFirstTeam = case_when(
      award == "All-Defensive First Team" ~ 1,
      TRUE ~ as.numeric(0)),
    
    allDefSecondTeam = case_when(
      award == "All-Defensive Second Team" ~ 1,
      TRUE ~ as.numeric(0)),
    
    allNBAFirstTeam = case_when(
      award == "All-NBA First Team" ~ 1,
      TRUE ~ as.numeric(0)),
    
    allNBASecondTeam = case_when(
      award == "All-NBA Second Team" ~ 1,
      TRUE ~ as.numeric(0)),
    
    MVP = case_when(
      award == "Most Valuable Player" ~ 1,
      TRUE ~ as.numeric(0)),
    
    defPOTY = case_when(
      award == "Defensive Player of the Year" ~ 1,
      TRUE ~ as.numeric(0))
  ) %>% 
  select(-award)

awards
```

#### The *allstar* Data Set

We wish to use All-Star data as an additional explanatory variable. To avoid complications with existing player statistics, we can disregard actual game performance and simply create an indicator variable for team  membership.

```{r}
# Filter for league and year
allstar <- allstar %>% 
  filter(league_id == "NBA", season_id >= 1979) %>%
  select(player_id, season_id) %>%
  mutate(allstar = 1) %>% 
  rename("playerID" = "player_id", "year" = "season_id")

# Check for duplicate entries
setequal(allstar, distinct(allstar))
```

Oops, looks like there's a duplicate entry. After a prolonged investigation, we find that Marques Johnson was incorrectly coded as *johnsma01* instead of *johnsma02*, causing a discrepancy for the All-Star team in 1979, which had both Marques Johnson *and* Magic Johnson.

```{r echo=FALSE}
dummy <- tbl_df(read.csv("basketball_player_allstar.csv"))
dummy %>%
  filter(first_name == "Marques")
```

We can correct this quirk and re-run our code.

```{r echo=FALSE}
allstar <- tbl_df(read.csv("basketball_player_allstar.csv"))
allstar$player_id[allstar$first_name == "Marques"] <- "johnsma02"
```

```{r}
allstar <- allstar %>% 
  filter(league_id == "NBA", season_id >= 1979) %>%
  select(player_id, season_id) %>%
  mutate(allstar = 1) %>% 
  rename("playerID" = "player_id", "year" = "season_id") # Rename variables to match format of players and awards

setequal(allstar, distinct(allstar))
```
Much better! Now we should be fine when we merge our data.


### Exploratory Data Analysis

We can get a feel of each variable by plotting the means of each season. Rebounds, 3-pointers, field goals, and free throws are plotted together as fills to get an idea of the proportions. 

```{r}
# Calculate the means of each statistic
playersmean <- players %>%
  group_by(year) %>% 
  summarize_if(is.numeric, mean)

# Create a plot for rebounds
playersmean %>% 
  select(year, contains("rebound")) %>% 
  gather(reboundType, count, -year) %>% 
  ggplot(aes(x = year, y = count, fill = reboundType)) + 
    geom_area() +
    scale_color_hue(labels = c("defensive", "offensive", "total"))

# Create a plot for 3-pointers
playersmean %>% 
  select(year, contains("three")) %>% 
  gather(shot, count, -year) %>% 
  ggplot(aes(x = year, y = count, fill = shot)) + 
    geom_area() +
    scale_color_hue(labels = c("attempted", "made"))

# Create a plot for field goals
playersmean %>% 
  select(year, contains("fg")) %>% 
  gather(fieldGoal, count, -year) %>% 
  ggplot(aes(x = year, y = count, fill = fieldGoal)) + 
    geom_area() +
    scale_color_hue(labels = c("attempted", "made"))

# Create a plot for free throws
playersmean %>% 
  select(year, contains("ft")) %>% 
  gather(freeThrow, count, -year) %>% 
  ggplot(aes(x = year, y = count, fill = freeThrow)) + 
    geom_area() +
    scale_color_hue(labels = c("attempted", "made"))

# Create line plots for everything else
for(i in names(playersmean)){
  if (!grepl("year|rebound|three|fg|ft", tolower(i))){
    plt <- playersmean %>% 
      ggplot(aes_string(x = "year", y = i)) + geom_line()
    print(plt)
  }
}

```

Looking at the plots above, we notice a few things:

1. 3-point shooting became an increasingly important part of the game over the years.
2. Despite the 3-point shooting, the points scored per game decreased overall.
3. Most importantly, **there's a noticeable dive in every statistic in 1998 and 2012**.


```{r}
players %>% 
  select(year, GP) %>% 
  group_by(year) %>% 
  summarize_if(is.numeric, max) %>% 
  ggplot(aes(x = year, y = GP, label = GP)) +
    geom_label(size = 3) +
    labs(title = "Games Played by Season")
```

In the history of the NBA, there have been [four lockouts](https://en.wikipedia.org/wiki/NBA_lockout). On two of these occassions (1995 and 1996), players and owners reached deals before the start of the regular season. However, the two most recent lockouts actually extended into what would have been the regular seasons, forcing shortened seasons of [50 games per team in 1998-1999](https://en.wikipedia.org/wiki/1998%E2%80%9399_NBA_lockout) and [66 games per team in 2011-2012](https://en.wikipedia.org/wiki/2011_NBA_lockout). Furthermore, the 1998-1999 lockout resulted in the cancellation of the season's All-Star game. 

## Feature Engineering

Some extra features are added to compare a player's performance to the his team and to the league. Note that, in order to avoid NaN entries, league and team offensive/defensive rebounds utilize `case_when()` to calculate the proportion of rebounds tallied for non-zero values, or set the value to zero otherwise.

```{r}
# Add some stats to compare by season
players <- players %>% 
  group_by(year) %>% 
  mutate(
    lgPoints = points / sum(points),
    lgAssists = assists / sum(assists),
    lgRebounds = rebounds / sum(rebounds),
    lgDRebounds = case_when(
      dRebounds != 0 ~ dRebounds / sum(dRebounds),
      TRUE ~ 0),
    lgORebounds = case_when(
      oRebounds != 0 ~ oRebounds / sum(oRebounds),
      TRUE ~ 0)) %>% 
  ungroup()

# Add some stats to compare by team
players <- players %>% 
  group_by(year, tmID) %>% 
  mutate(
    tmPoints = points / sum(points),
    tmAssists = assists / sum(assists),
    tmRebounds = rebounds / sum(rebounds),
    tmDRebounds = case_when(
      dRebounds != 0 ~ dRebounds / sum(dRebounds),
      TRUE ~ 0),
    tmORebounds = case_when(
      oRebounds != 0 ~ oRebounds / sum(oRebounds),
      TRUE ~ 0)) %>% 
  ungroup()
```

The stats generated in the code above are calculated in separate groupings, and are ungrouped afterwards to add more player-specific features (see [basketball-reference.com](https://www.basketball-reference.com/about/glossary.html#mp)). 

```{r}
# More individual player stats
players <- players %>% 
  mutate(
    ftPct = ftMade / ftAttempted,
    fgPct = fgMade / fgAttempted,
    efgPct = (fgMade + 0.5 * threeMade) / fgAttempted,
    PPG = points / GP,
    astTovRatio = case_when(
      turnovers != 0 ~ assists / turnovers,
      TRUE ~ 0),
    dReboundPct = dRebounds / rebounds,
    oReboundPct = oRebounds / rebounds,
    totalGameScore = points + 0.4 * (fgMade + threeMade) - 0.7 * fgAttempted - 0.4 * (ftAttempted - ftMade) + 0.7 * oRebounds + 0.3 * dRebounds + steals + 0.7 * assists + 0.7 * blocks - 0.4 * PF - turnovers,
    avgGameScore = totalGameScore / GP)
```

To avoid `Inf` values, `case_when()` is again utilized for the assist-to-turnover ratios.

Summary of new features added:

* League/Team points/assists/rebounds
* Field Goal and Free Throw Percentage (FG%/FT%)
* Effective Field Goal Percentage (eFG%)
* Points Per Game (PPG)
* Assist to Turnover Ratio
* Total and Average Game Score

```{r}
glimpse(players)
```

***

## Future work to be done

There are many observations with incomplete data. Further cleaning will be performed after exploratory data analysis, but the existing data set can be saved with the following code:

``` {r}
write.csv(players, "players_clean.csv")
```